#
# pilha : cmj-ecs-api
# - diagrama
# client
# 	security group 1 (filtro = in, tcp, 80, *ip)
# 		load balance
# 			security group (filtro = in, tcp, 80, security group 1)
# 				task/servico/container
# - dependencias
#   arn:aws:iam::105254198021:policy/cmj-parameters-dev


AWSTemplateFormatVersion: 2010-09-09
Description: Template que cria uma instancia ecs/fargate. Autor Fernando Rodrigues
Parameters:
  ServiceName:
    Type: String
    Default: cmjApi  
  ServiceImage:
    Type: String
    Default: nandolrs/cfcorewapicmj-image    
    # update with the name of the service
  VPC:
    Type: AWS::EC2::VPC::Id
  ContainerPort:
    Type: Number
    Default: 80
  LoadBalancerPort:
    Type: Number
    Default: 443    #original = 443 se usar o certificado, 80 se nao usar o certificado     
  ServiceHealth:
    Type: String
    Default: /api
    # caminho do health do servico
  EnviromentName:
    Type: String
    Default: dev
    AllowedValues:
    - dev
    - hom
    - prd
    # nome do ambiente: dev/hom/prd/...    
  EnviromentNameApi:
    Type: String
    Default: https://api.negritando.com
    # caminho do load balance da api  
  LogGroupNamePath:
    Type: String
    Default: /ecs/api-front
    # caminho do log do cloud whatch      
  CertificateUsageQuestion:
    Type: String
    Default: no
    AllowedValues :
      - yes
      - no    
    Description : Are you to use a SSL/TSL certificate?
    # to question if a certificate will be use
  CMJCertificateArn:
    Type: String
    Default: arn:aws:acm:sa-east-1:105254198021:certificate/703972f3-0eb8-4205-a33b-20baa936d252
    Description : Input the ARN SSL/TSL certificate
    # update with the ARN of certificate
Conditions:
  CMJCertificateUsageQuestionCondition: !Equals
    - !Ref CertificateUsageQuestion
    - yes
  CMJCertificateUsageQuestionNoCondition: !Equals
    - !Ref CertificateUsageQuestion
    - no
Metadata:
  'AWS::CloudFormation::Designer':
    0539f1a2-9de4-436a-b92b-5c965b0a443a:
      size:
        width: 60
        height: 60
      position:
        x: 60
        'y': 90
      z: 1
      embeds: []
      dependson:
        - d635bde5-ab48-41d2-bde6-7164956f6d9b
    d635bde5-ab48-41d2-bde6-7164956f6d9b:
      size:
        width: 60
        height: 60
      position:
        x: 180
        'y': 90
      z: 1
      embeds: []
    3066b0fa-3eb0-4c58-9f70-ae9560ac3cf2:
      size:
        width: 60
        height: 60
      position:
        x: 324.36106409780837
        'y': 91.16686066259285
      z: 0
      dependson:
        - d635bde5-ab48-41d2-bde6-7164956f6d9b
    79ce3acf-1400-4a97-aadc-abc2a1766bd9:
      source:
        id: 3066b0fa-3eb0-4c58-9f70-ae9560ac3cf2
      target:
        id: d635bde5-ab48-41d2-bde6-7164956f6d9b
      z: 2
Resources:
  CMJECSCluster:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterName: cmj
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT
      DefaultCapacityProviderStrategy:
        - CapacityProvider: FARGATE
          Weight: 1
        - CapacityProvider: FARGATE_SPOT
          Weight: 1
    Metadata:
      'AWS::CloudFormation::Designer':
        id: d635bde5-ab48-41d2-bde6-7164956f6d9b
  CMJECSIamRoleEcsTasks:
    Type: AWS::IAM::Role
    Properties:
      RoleName: cmjIAMRole-ecs-tasks
      AssumeRolePolicyDocument:
        Statement:
            - Action: 'sts:AssumeRole'
              Principal:
                Service: ecs-tasks.amazonaws.com
              Effect: Allow
            - Action: 'sts:AssumeRole'
              Principal:
                Service: ssm.amazonaws.com
              Effect: Allow
      Policies:
        - PolicyName: cmjIAMPolicy-ssm-parameter
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Action:
                  - 'ssm:GetParameter'
                Resource: !Sub 'arn:aws:ssm:*:105254198021:parameter/*'
                Effect: Allow
  CMJECSIamRoleEcsTasksExecution:
    Type: AWS::IAM::Role
    Properties:
      RoleName: cmjIAMRole-ecs-tasks-execution
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy'
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Ref LogGroupNamePath
  ContainerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Join ['', [!Ref ServiceName, ContainerSecurityGroup]]
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref ContainerPort
          ToPort: !Ref ContainerPort
          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup      
  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Join ['', [!Ref ServiceName, LoadBalancerSecurityGroup]]
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref LoadBalancerPort
          ToPort: !Ref LoadBalancerPort
          CidrIp: 0.0.0.0/0      
  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      LoadBalancerAttributes:
        # this is the default, but is specified here in case it needs to be changed
        - Key: idle_timeout.timeout_seconds
          Value: 60
      Name: !Join ['', [!Ref ServiceName, LoadBalancer]]
      # "internal" is also an option
      Scheme: internet-facing
      SecurityGroups:
        - !Ref LoadBalancerSecurityGroup
      Subnets:
            - subnet-ecbaf9b7
            - subnet-561f5b30
            - subnet-06106a4f
  TargetGroupHTTP:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 10
      # will look for a 200 status code by default unless specified otherwise
      HealthCheckPath: !Ref ServiceHealth
      HealthCheckTimeoutSeconds: 5
      UnhealthyThresholdCount: 2
      HealthyThresholdCount: 2
      Name: !Join ['', [!Ref ServiceName, TargetGroup]]
      Port: !Ref ContainerPort
      Protocol: HTTP
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 60 # default is 300
      TargetType: ip
      VpcId: !Ref VPC
  ListenerHTTPS:
    Condition:  CMJCertificateUsageQuestionCondition
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - TargetGroupArn: !Ref TargetGroupHTTP # ouve HTTPS, mas entrega HTTP para o servico
          Type: forward
      LoadBalancerArn: !Ref LoadBalancer
      Port: !Ref LoadBalancerPort
      Protocol: HTTPS
      Certificates:
         - CertificateArn: !Ref CMJCertificateArn    
  CMJECSTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      Memory: 4096
      Cpu: 512
      ExecutionRoleArn: !Ref CMJECSIamRoleEcsTasksExecution
      TaskRoleArn : !Ref CMJECSIamRoleEcsTasks
      ContainerDefinitions:
        - Name:  !Ref ServiceName
          Image: !Ref ServiceImage
          PortMappings:
            - ContainerPort: !Ref ContainerPort
          # Send logs to CloudWatch Logs
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-region: !Ref AWS::Region
              awslogs-group: !Ref LogGroup
              awslogs-stream-prefix: ecs
          Environment :
            - Name: CMJ_AMBIENTE
              Value : !Ref EnviromentName
            - Name: REACT_APP_SERVER_URL
              Value : !Ref EnviromentNameApi              
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 0539f1a2-9de4-436a-b92b-5c965b0a443a
    DependsOn:
      - CMJECSCluster
  CMJECSServiceHTTP:
    Type: 'AWS::ECS::Service'
    Properties:
      ServiceName: !Ref ServiceName
      LaunchType : FARGATE
      TaskDefinition : !Ref CMJECSTaskDefinition
      Cluster : !Ref CMJECSCluster   
      DesiredCount : 2
      DeploymentConfiguration :
        MinimumHealthyPercent : 100
        MaximumPercent : 200
      NetworkConfiguration :
        AwsvpcConfiguration :
          SecurityGroups : 
            - !Ref ContainerSecurityGroup
          AssignPublicIp : ENABLED
          Subnets : 
            - subnet-ecbaf9b7
            - subnet-561f5b30
            - subnet-06106a4f
      LoadBalancers:
        - ContainerName: !Ref ServiceName # mesmo que ContainerDefinitions.Name
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref TargetGroupHTTP            
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 3066b0fa-3eb0-4c58-9f70-ae9560ac3cf2
    DependsOn:
      - CMJECSCluster    
      - ListenerHTTPS     
Outputs:
  CMJECSClusterOutputs:
    Description: Cluster ecs/fargate
    Value: !Ref CMJECSCluster
    Export:
      Name: CMJECSClusterOut 
  CMJECSIamRoleEcsTasksOutputs:
    Description: IamRole task ecs/fargate
    Value: !Ref CMJECSIamRoleEcsTasks
    Export:
      Name: CMJECSIamRoleEcsTasksOut    
  CMJECSIamRoleEcsTasksExecutionOutputs:
    Description: IamRole tasks execution ecs/fargate
    Value: !Ref CMJECSIamRoleEcsTasksExecution
    Export:
      Name: CMJECSIamRoleEcsTasksExecutionOut          


                         