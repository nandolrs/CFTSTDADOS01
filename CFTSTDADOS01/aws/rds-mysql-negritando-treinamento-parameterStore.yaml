#
# pilha : negritando-parameterStore

AWSTemplateFormatVersion: 2010-09-09
Description: Template que cria uma instancia mysql. Autor Fernando Rodrigues
Parameters:
  CMJDBInstanceIdentifier:
    Default: dbnegritando
    Description: Nome da instancia
    Type: String
    MinLength: '1'
    MaxLength: '63'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: 
      Precisa iniciar com letras e n√£o deve terminar com um ou mais hifens
  CMJDBInstanceEndpoint:
    Default: ... informe nome.dominio ...
    Description: Endpoint da instancia
    Type: String
    #MinLength: '1'
    #MaxLength: '63'
    #AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Precisa iniciar com letras e nao deve terminar com um ou mais hifens      
  DBName:
    Default: dbcftreino
    Description: Nome da base de dados
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Deve comecar com uma letra e conter somente coracteres alfanumericos.
  DBInstanceClass:
    Default: db.t3.micro
    Description: Classe da instancia DB
    Type: String
    ConstraintDescription: Selecione um tipo valido de instancia DB.
  DBAllocatedStorage:
    Default: '20'
    Description: Tamanho da base de dados (GiB)
    Type: Number
    MinValue: '20'
    MaxValue: '65536'
    ConstraintDescription: Deve estar entre 20 e 65536 GiB.
  DBUsername:
    Default: dandaraQuilombo
    Description: Nome do usuario para acessar a base de dados  MySQL.
    Type: String
    MinLength: '1'
    MaxLength: '16'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Deve comecar com uma letra e conter somente caracteres.
  DBPassword:
    NoEcho: 'true'
    Description: Senha de acesso da base de dados MySQL.
    Type: String
    MinLength: '8'
    MaxLength: '41'
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: Deve conter somente caracteres.
  CMJVpcId:
    Type: AWS::EC2::VPC::Id
  CMJCidrIpPermitido:
    Default: 0.0.0.0/32
    Description: Informe o IP da sua estacao de trabalho para que somente ela tenha acesso ao servico.
    Type: String
  CMJEnviromentName:
    Default: treinamento
    Type: String
    AllowedValues:
    - dev
    - hom
    - prd
    - treinamento
  CMJDBInstanceEndpointCriarParametro:
    Default: nao
    Type: String
    AllowedValues:
    - sim
    - nao
Conditions:
  CMJCriarParametroInstanciaSimCondition: !Equals
    - !Ref CMJDBInstanceEndpointCriarParametro
    - nao
  CMJCriarParametroInstanciaNaoCondition: !Equals
    - !Ref CMJDBInstanceEndpointCriarParametro
    - sim    
Metadata: 
  AWS::CloudFormation::Interface: 
    ParameterGroups: 
      - 
        Label: 
          default: "Dados da rede e ambiente"
        Parameters: 
          - CMJEnviromentName
          - CMJVpcId
          - CMJCidrIpPermitido
          - CMJDBInstanceEndpointCriarParametro
          - CMJDBInstanceEndpoint
      - 
        Label: 
          default: "Dados do servidor"
        Parameters: 
          - CMJDBInstanceIdentifier
          - DBName
          - DBInstanceClass
          - DBAllocatedStorage
      - 
        Label: 
          default: "Dados do usuario"
        Parameters: 
          - DBUsername
          - DBPassword
          - CMJParametrosUsuarioTimeout
    ParameterLabels: 
      CMJDBInstanceIdentifier: 
        default: "Nome da instancia"      
      DBName: 
        default: "Nome da base de dados"
      DBInstanceClass: 
        default: "Classe da instancia DB"     
      DBAllocatedStorage: 
        default: "Tamanho do armazenamento"             
      DBUsername: 
        default: "Nome do usuario"      
      DBPassword: 
        default: "Senha"
      CMJParametrosUsuarioTimeout: 
        default: "Prazo para conexao (time-out)"                        
      CMJVpcId: 
        default: "Nome da rede"    
      CMJCidrIpPermitido: 
        default: "IP para acesso publico"    
      CMJEnviromentName: 
        default: "Ambiente (desenvolvimento/testes/producao/treinamento)"                                       
      CMJDBInstanceEndpointCriarParametro: 
        default: "Criar parametro da instancia?"                                                               
Resources:
  CMJParametrosServidorNome:
    Type: AWS::SSM::Parameter
    #DependsOn: CMJRDSDBInstance
    Condition: CMJCriarParametroInstanciaSimCondition    
    Properties: 
      Name:  !Join ['', ['/cmjw/', !Ref CMJEnviromentName ,'/servidor/nome']]
      Tags: 
        Ambiente : !Ref CMJEnviromentName
      Type: String 
      Value:  nomeDoServidor #!Ref DBInstanceID      
  CMJParametrosServidorPorta:
    Type: AWS::SSM::Parameter
    #DependsOn: CMJRDSDBInstance
    Condition: CMJCriarParametroInstanciaNaoCondition    
    Properties: 
      Name:  !Join ['', ['/cmjw/', !Ref CMJEnviromentName ,'/servidor/porta']]
      Tags: 
        Ambiente : !Ref CMJEnviromentName
      Type: String 
      Value:  3306   
  CMJParametrosUsuarioBanco:
    Type: AWS::SSM::Parameter
    Condition: CMJCriarParametroInstanciaNaoCondition    
    Properties: 
      Name:  !Join ['', ['/cmjw/', !Ref CMJEnviromentName ,'/usuario/banco']]
      Tags: 
        Ambiente : !Ref CMJEnviromentName
      Type: String 
      Value:  !Ref DBName 
  CMJParametrosUsuarioNome:
    Type: AWS::SSM::Parameter
    Condition: CMJCriarParametroInstanciaNaoCondition    
    Properties: 
      Name:  !Join ['', ['/cmjw/', !Ref CMJEnviromentName ,'/usuario/nome']]
      Tags: 
        Ambiente : !Ref CMJEnviromentName
      Type: String 
      Value:  !Ref DBUsername                      
  CMJParametrosUsuarioSenha:
    Type: AWS::SSM::Parameter
    Condition: CMJCriarParametroInstanciaNaoCondition    
    Properties: 
      Name:  !Join ['', ['/cmjw/', !Ref CMJEnviromentName ,'/usuario/senha']]
      Tags: 
        Ambiente : !Ref CMJEnviromentName
      Type: String 
      Value:  !Ref DBPassword          
  CMJParametrosUsuarioTimeout:
    Type: AWS::SSM::Parameter
    Condition: CMJCriarParametroInstanciaNaoCondition    
    Properties: 
      Name:  !Join ['', ['/cmjw/', !Ref CMJEnviromentName ,'/usuario/time-out']]
      Tags: 
        Ambiente : !Ref CMJEnviromentName
      Type: String 
      Value:  360000  
